<p>That <code>END</code> before <code>END WHILE;</code> is causing the problem. You already have an END on line 46, so this one is trying to end the function. I'll bet you can just remove it.</p>